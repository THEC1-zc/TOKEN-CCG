<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TOKEN - Game v1.7.6</title>
  <!-- Version: V1.7.6 -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/wallet-ui.css">
  <link rel="stylesheet" href="assets/header.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: #FFF; -webkit-tap-highlight-color: transparent; }

```
/* Setup */
.setup-screen { min-height: 100vh; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(180deg, #0a0a0f 0%, #12121f 50%, #0a0a0f 100%); }
.setup-content { width: 100%; max-width: 380px; background: #141419; border-radius: 16px; padding: 24px; text-align: center; }
.setup-title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; letter-spacing: 4px; margin-bottom: 8px; }
.setup-subtitle { color: #71717A; font-size: 13px; margin-bottom: 24px; }
.setup-label { font-size: 11px; color: #A1A1AA; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; text-align: left; }
.setup-select { width: 100%; padding: 14px; background: #0a0a0f; border: 1px solid #27272A; border-radius: 8px; color: #FFF; font-size: 14px; margin-bottom: 16px; }
.setup-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #F7931A, #FFD93D); border: none; border-radius: 10px; color: #000; font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px; cursor: pointer; }
.setup-btn:disabled { background: #27272A; color: #52525B; }
.back-link { color: #71717A; font-size: 13px; margin-top: 16px; display: inline-block; text-decoration: none; }
.no-decks-msg { padding: 16px; background: #0a0a0f; border-radius: 8px; color: #71717A; font-size: 13px; margin-bottom: 16px; }
.no-decks-msg a { color: #F7931A; }

/* JollyDraw */
.jd-screen { min-height: 100vh; padding: 16px; background: linear-gradient(180deg, #0a0a0f 0%, #12121f 50%, #0a0a0f 100%); display: none; flex-direction: column; }
.jd-screen.visible { display: flex; }
.jd-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; text-align: center; margin-bottom: 4px; }
.jd-subtitle { color: #71717A; font-size: 11px; text-align: center; margin-bottom: 12px; }
.jd-confirm-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #10B981, #6EE7B7); border: none; border-radius: 8px; color: #000; font-family: 'Bebas Neue', sans-serif; font-size: 16px; cursor: pointer; margin-bottom: 12px; }
.jd-confirm-btn:disabled { background: #27272A; color: #52525B; }
.jd-cards { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
.jd-card { width: 50px; height: 75px; border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 2px solid #27272A; background: linear-gradient(135deg, #1a1a2e, #0f0f1a); }
.jd-card.selected { border-color: #F7931A; box-shadow: 0 4px 12px #F7931A44; }
.jd-card-value { font-family: 'Bebas Neue', sans-serif; font-size: 18px; }

/* Coin Toss */
.cointoss-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 200; flex-direction: column; }
.cointoss-overlay.visible { display: flex; }
.coin { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #F7931A, #FFD93D); display: flex; align-items: center; justify-content: center; font-size: 56px; margin-bottom: 16px; animation: coinFlip 1.5s ease-out; }
@keyframes coinFlip { 0% { transform: rotateY(0) scale(0.5); opacity: 0; } 50% { transform: rotateY(1080deg) scale(1.2); } 100% { transform: rotateY(1800deg) scale(1); opacity: 1; } }
.cointoss-result { font-family: 'Bebas Neue', sans-serif; font-size: 36px; letter-spacing: 4px; }
.cointoss-result.bull { color: #10B981; }
.cointoss-result.bear { color: #EF4444; }
.cointoss-text { color: #A1A1AA; font-size: 14px; }

/* Game Wrapper */
.game-wrapper { display: none; flex-direction: column; height: 100vh; height: 100dvh; background: #000; max-width: 500px; margin: 0 auto; }
.game-wrapper.visible { display: flex; }

/* Header */
.game-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #0a0a0f; flex-shrink: 0; }
.surrender-btn { padding: 6px 10px; background: transparent; border: 1px solid #EF4444; border-radius: 6px; color: #EF4444; font-size: 10px; cursor: pointer; }
.wallet-placeholder { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: #141419; border-radius: 20px; font-size: 10px; color: #71717A; }
.wallet-dot { width: 6px; height: 6px; background: #F7931A; border-radius: 50%; }
.header-timer { display: flex; align-items: center; gap: 6px; }
.timer-bar { width: 40px; height: 5px; background: #27272A; border-radius: 3px; overflow: hidden; }
.timer-fill { height: 100%; background: #10B981; transition: width 0.1s linear; }
.timer-fill.warning { background: #F7931A; }
.timer-fill.danger { background: #EF4444; }
.timer-text { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: bold; }
.timer-text.warning { color: #F7931A; }
.timer-text.danger { color: #EF4444; animation: blink 0.5s infinite; }
@keyframes blink { 50% { opacity: 0.5; } }

/* Score Bar */
.score-bar { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; background: #141419; flex-shrink: 0; }
.score-label { font-size: 9px; color: #71717A; text-transform: uppercase; }
.score-value { font-family: 'Bebas Neue', sans-serif; font-size: 24px; }
.score-you { color: #10B981; }
.score-ai { color: #EF4444; }
.turn-badge { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 600; }
.turn-badge.your-turn { background: #10B98133; color: #10B981; }
.turn-badge.ai-turn { background: #EF444433; color: #EF4444; }

/* Board */
.game-board { flex: 1; display: flex; flex-direction: column; background: url('assets/game-bg.svg') center/cover no-repeat, linear-gradient(180deg, #1a5a3a 0%, #0d3d2a 100%); padding: 6px; min-height: 0; }

/* Player Row Layout: JD | Hand | Captures */
.player-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 4px; gap: 6px; }
.player-row.ai { flex-direction: row; }
.player-row.you { flex-direction: row; }

.side-pile { display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 50px; }
.side-pile-label { font-size: 8px; color: #fff8; text-transform: uppercase; }
.side-pile-stack { position: relative; width: 40px; height: 60px; }
.side-pile-card { position: absolute; width: 40px; height: 60px; background: url('cardback.png') center/cover, linear-gradient(135deg, #10B981, #EF4444); border: 1px solid #000; border-radius: 4px; }
.side-pile-card:nth-child(1) { top: 0; left: 0; }
.side-pile-card:nth-child(2) { top: 2px; left: 1px; }
.side-pile-card:nth-child(3) { top: 4px; left: 2px; }
.side-pile-count { font-size: 9px; color: #fff; background: #0008; padding: 1px 5px; border-radius: 3px; }

.jd-pile { cursor: pointer; }
.jd-pile.disabled { opacity: 0.4; pointer-events: none; }
.jd-pile.selected .side-pile-stack { box-shadow: 0 0 8px #F7931A; }

.hand-area { flex: 1; display: flex; justify-content: center; gap: 4px; }
.ai-hand { display: flex; gap: 3px; }
.player-hand { display: flex; gap: 5px; }

.card-back { width: 40px; height: 60px; background: url('cardback.png') center/cover, linear-gradient(135deg, #10B981 0%, #10B981 48%, #000 50%, #EF4444 52%, #EF4444 100%); border: 1px solid #000; border-radius: 5px; }

.table-area { flex: 1; display: flex; align-items: center; justify-content: center; gap: 10px; }
.draw-pile { display: flex; flex-direction: column; align-items: center; gap: 3px; }
.pile-stack { position: relative; width: 44px; height: 66px; }
.pile-card { position: absolute; width: 44px; height: 66px; background: url('cardback.png') center/cover, linear-gradient(135deg, #10B981 0%, #10B981 48%, #000 50%, #EF4444 52%, #EF4444 100%); border: 2px solid #000; border-radius: 5px; }
.pile-card:nth-child(2) { top: 2px; left: 2px; }
.pile-count { font-size: 9px; color: #fff; background: #0008; padding: 2px 6px; border-radius: 4px; }
.table-cards { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; padding: 10px; background: #0004; border-radius: 8px; min-width: 160px; min-height: 80px; }
.table-empty { color: #fff4; font-size: 11px; }

/* Cards */
.game-card { width: 48px; height: 72px; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: linear-gradient(135deg, #1a1a2e, #0f0f1a); transition: transform 0.1s; }
.game-card:active { transform: scale(0.95); }
.game-card.selected { transform: translateY(-6px); box-shadow: 0 6px 16px #F7931A66; }
.game-card.highlight-capture { box-shadow: 0 0 10px #10B981; }
.game-card.bitcoin { border: 2px solid #F7931A; }
.game-card.ethereum { border: 2px solid #C0C0C0; }
.game-card.base { border: 2px solid #0052FF; }
.game-card.tysm { border: 2px solid #10B981; }
.game-card-symbol { font-size: 9px; }
.house-bitcoin { color: #F7931A; }
.house-ethereum { color: #C0C0C0; }
.house-base { color: #0052FF; }
.house-tysm {
  background: linear-gradient(90deg, #FACC15, #3B82F6);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;
}
.game-card-symbol.house-bitcoin { color: #F7931A; }
.game-card-symbol.house-ethereum { color: #C0C0C0; }
.game-card-symbol.house-base { color: #0052FF; }
.game-card-symbol.house-tysm {
  background: linear-gradient(90deg, #FACC15, #3B82F6);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;
}
.game-card.tysm .game-card-symbol {
  background: linear-gradient(90deg, #FACC15, #3B82F6);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent !important;
}
.game-card-value { font-family: 'Bebas Neue', sans-serif; font-size: 20px; }

/* Footer */
.game-footer { background: #0a0a0f; flex-shrink: 0; }
.log-preview { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; cursor: pointer; }
.log-preview-text { font-size: 10px; color: #A1A1AA; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.log-preview-text .p { color: #10B981; }
.log-preview-text .a { color: #EF4444; }
.log-toggle { font-size: 12px; color: #71717A; transition: transform 0.2s; }
.log-toggle.open { transform: rotate(180deg); }
.log-expanded { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
.log-expanded.visible { max-height: 180px; overflow-y: auto; }
.log-content { padding: 0 12px 10px; }
.log-entry { padding: 5px 8px; margin-bottom: 3px; border-radius: 4px; font-size: 9px; }
.log-entry.player { background: #10B98122; border-left: 2px solid #10B981; }
.log-entry.ai { background: #EF444422; border-left: 2px solid #EF4444; }
.log-entry.system { background: #F7931A22; border-left: 2px solid #F7931A; }

/* Overlays */
.play-animation { position: fixed; inset: 0; background: #000c; display: none; align-items: center; justify-content: center; z-index: 180; flex-direction: column; gap: 10px; }
.play-animation.visible { display: flex; }
.play-animation .played-card { width: 70px; height: 105px; animation: cardPlay 0.4s ease-out; }
@keyframes cardPlay { 0% { transform: scale(0.3) translateY(60px); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
.play-animation .play-info { font-family: 'Bebas Neue', sans-serif; font-size: 18px; }
.play-animation .play-info.player { color: #10B981; }
.play-animation .play-info.ai { color: #EF4444; }
.play-animation .capture-info { color: #F7931A; font-size: 12px; }
.play-animation .captured-cards { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
.play-animation .mini-card { width: 36px; height: 54px; font-size: 9px; }

.toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: #141419; border: 2px solid #F7931A; border-radius: 12px; padding: 14px 28px; text-align: center; z-index: 190; transition: transform 0.2s; }
.toast.visible { transform: translate(-50%, -50%) scale(1); }
.toast-icon { font-size: 32px; }
.toast-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; }

.gameover-overlay { position: fixed; inset: 0; background: #000e; display: none; align-items: center; justify-content: center; z-index: 200; padding: 16px; }
.gameover-overlay.visible { display: flex; }
.gameover-content { background: #141419; border: 2px solid #F7931A; border-radius: 14px; padding: 20px; text-align: center; width: 100%; max-width: 320px; }
.gameover-icon { font-size: 42px; margin-bottom: 10px; }
.gameover-title { font-family: 'Bebas Neue', sans-serif; font-size: 32px; margin-bottom: 12px; }
.gameover-title.win { color: #10B981; }
.gameover-title.lose { color: #EF4444; }
.gameover-score { display: flex; justify-content: center; gap: 28px; margin-bottom: 16px; }
.gameover-score-value { font-family: 'Bebas Neue', sans-serif; font-size: 36px; }
.gameover-score-label { font-size: 10px; color: #71717A; text-transform: uppercase; }
.gameover-details { margin-bottom: 16px; font-size: 11px; color: #A1A1AA; }
.gameover-detail { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #27272A; }
.gameover-actions { display: flex; gap: 10px; }
.gameover-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-family: 'Bebas Neue', sans-serif; font-size: 14px; cursor: pointer; }
.btn-secondary { background: #27272A; color: #fff; }
.btn-primary { background: linear-gradient(135deg, #10B981, #6EE7B7); color: #000; }

.surrender-overlay { position: fixed; inset: 0; background: #000e; display: none; align-items: center; justify-content: center; z-index: 210; padding: 16px; }
.surrender-overlay.visible { display: flex; }
.surrender-content { background: #141419; border: 2px solid #EF4444; border-radius: 14px; padding: 20px; text-align: center; max-width: 280px; }
.surrender-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: #EF4444; margin-bottom: 10px; }
.surrender-text { font-size: 12px; color: #A1A1AA; margin-bottom: 16px; }
.surrender-actions { display: flex; gap: 10px; }
.surrender-actions button { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; }
.btn-cancel { background: #27272A; color: #fff; }
.btn-surrender { background: #EF4444; color: #fff; }

.hidden { display: none !important; }
```

  </style>
</head>
<body>
  <header class="app-header">
    <div class="header-left">
      <a class="header-brand" href="index.html">
        <img src="assets/main%20icon.png" alt="TOKEN">
        <span class="header-title token-brand">TOKEN</span>
      </a>
      <span class="header-sep">/</span>
      <span class="header-page">Game</span>
    </div>
    <nav class="header-nav">
      <a href="index.html">Home</a>
      <a href="index.html#how-to-play">How to Play</a>
      <a href="docs/rules.md">Rules</a>
    </nav>
    <div class="header-right">
      <span class="status-pill">Test Mode</span>
      <div id="walletHeaderMount"></div>
    </div>
  </header>
  <div class="setup-screen" id="setupScreen">
    <div class="setup-content">
      <div class="setup-title token-brand">TOKEN</div>
      <p class="setup-subtitle">Play vs AI</p>
      <div id="noDecksMsg" class="no-decks-msg" style="display:none;">No battle decks.<br><a href="deck-builder.html">Create one ‚Üí</a></div>
      <label class="setup-label">Battle Deck</label>
      <select class="setup-select" id="deckSelect" onchange="onDeckSelect()"><option value="">-- Select --</option></select>
      <button class="setup-btn" id="startBtn" onclick="startJD()" disabled>START</button>
      <a href="index.html" class="back-link">‚Üê <img class="token-back" src="assets/token_icon.png" alt="TOKEN"> Home</a>
    </div>
  </div>

  <div class="jd-screen" id="jdScreen">
    <div class="jd-title">üÉè JOLLYDRAW</div>
    <p class="jd-subtitle">Pick 1 from each deck</p>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button class="jd-confirm-btn" style="flex:1;background:#27272A;color:#fff;" onclick="autoSelectJD()">‚ö° AUTO</button>
      <button class="jd-confirm-btn" id="jdConfirmBtn" style="flex:2;" onclick="confirmJD()" disabled>CONFIRM</button>
    </div>
    <div class="jd-cards" id="jdCards"></div>
  </div>

  <div class="cointoss-overlay" id="cointossOverlay">
    <div class="coin" id="coin">ü™ô</div>
    <div class="cointoss-result" id="cointossResult">BULL</div>
    <div class="cointoss-text" id="cointossText">You first!</div>
  </div>

  <div class="game-wrapper" id="gameWrapper">
    <div class="game-header">
      <button class="surrender-btn" onclick="showSurrender()">üè≥Ô∏è</button>
      <div class="wallet-placeholder"><div class="wallet-dot"></div><span>Guest</span></div>
      <div class="header-timer"><div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div><div class="timer-text" id="timerText">15</div></div>
    </div>
    <div class="score-bar">
      <div><div class="score-label">You</div><div class="score-value score-you" id="scoreYou">0</div></div>
      <div class="turn-badge your-turn" id="turnBadge">Your Turn</div>
      <div><div class="score-label">AI</div><div class="score-value score-ai" id="scoreAI">0</div></div>
    </div>
    <div class="game-board">
      <!-- AI Row: JD | Hand | Captures -->
      <div class="player-row ai">
        <div class="side-pile">
          <div class="side-pile-label">JD</div>
          <div class="side-pile-stack" id="aiJDStack"></div>
          <div class="side-pile-count" id="aiJDCount">2</div>
        </div>
        <div class="hand-area">
          <div class="ai-hand" id="aiHand"></div>
        </div>
        <div class="side-pile">
          <div class="side-pile-label">Won</div>
          <div class="side-pile-stack" id="aiCaptureStack"></div>
          <div class="side-pile-count" id="aiCaptureCount">0</div>
        </div>
      </div>

```
  <!-- Table -->
  <div class="table-area">
    <div class="draw-pile">
      <div class="pile-stack"><div class="pile-card"></div><div class="pile-card"></div></div>
      <div class="pile-count" id="deckCount">0</div>
    </div>
    <div class="table-cards" id="tableCards"><span class="table-empty">-</span></div>
  </div>
  
  <!-- Player Row: JD | Hand | Captures -->
  <div class="player-row you">
    <div class="side-pile jd-pile" id="playerJDPile" onclick="toggleJDPile()" ondblclick="selectJDPile()">
      <div class="side-pile-label">JD</div>
      <div class="side-pile-stack" id="playerJDStack"></div>
      <div class="side-pile-count" id="playerJDCount">2</div>
    </div>
    <div class="hand-area">
      <div class="player-hand" id="playerHand"></div>
    </div>
    <div class="side-pile">
      <div class="side-pile-label">Won</div>
      <div class="side-pile-stack" id="playerCaptureStack"></div>
      <div class="side-pile-count" id="playerCaptureCount">0</div>
    </div>
  </div>
</div>
<div class="game-footer">
  <div class="log-preview" onclick="toggleLog()">
    <div class="log-preview-text" id="logPreview">Game started</div>
    <span class="log-toggle" id="logToggle">‚ñ≤</span>
  </div>
  <div class="log-expanded" id="logExpanded"><div class="log-content" id="logContent"></div></div>
</div>
```

  </div>

  <div class="play-animation" id="playAnimation">
    <div class="play-info" id="playInfo">YOU</div>
    <div class="played-card game-card" id="playedCard"></div>
    <div class="capture-info" id="captureInfo"></div>
    <div class="captured-cards" id="capturedCards"></div>
  </div>

  <div class="toast" id="toast"><div class="toast-icon" id="toastIcon">üéØ</div><div class="toast-title" id="toastTitle"></div></div>

  <div class="gameover-overlay" id="gameoverOverlay">
    <div class="gameover-content">
      <div class="gameover-icon" id="gameoverIcon">üèÜ</div>
      <div class="gameover-title" id="gameoverTitle">YOU WIN!</div>
      <div class="gameover-score">
        <div><div class="gameover-score-value score-you" id="finalScoreYou">0</div><div class="gameover-score-label">You</div></div>
        <div><div class="gameover-score-value score-ai" id="finalScoreAI">0</div><div class="gameover-score-label">AI</div></div>
      </div>
      <div class="gameover-details" id="gameoverDetails"></div>
      <div class="gameover-actions">
        <button class="btn-secondary" onclick="location.reload()">Again</button>
        <button class="btn-primary" onclick="location.href='index.html'">Home</button>
      </div>
    </div>
  </div>

  <div class="surrender-overlay" id="surrenderOverlay">
    <div class="surrender-content">
      <div class="surrender-title">üè≥Ô∏è SURRENDER?</div>
      <p class="surrender-text">You lose 0-3. No XP.</p>
      <div class="surrender-actions">
        <button class="btn-cancel" onclick="hideSurrender()">Cancel</button>
        <button class="btn-surrender" onclick="confirmSurrender()">Quit</button>
      </div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- TOKEN DB Client -->
  <script src="supabase/supabase-client.js"></script>
<script>
const HOUSES = { bitcoin: { symbol: '‚Çø', primary: '#F7931A' }, ethereum: { symbol: '‚óä', primary: '#C0C0C0' }, base: { symbol: '‚ñ†', primary: '#0052FF' }, tysm: { symbol: 'üôè', primary: '#3B82F6' } };
const TURN_TIME = 15;
let timer = null, timeLeft = TURN_TIME, logOpen = false;
let gs = { phase: 'setup', turn: 'player', deck: [], table: [], playerHand: [], aiHand: [], playerCaptures: [], aiCaptures: [], playerJD: [], aiJD: [], playerTokens: 0, aiTokens: 0, selected: null, useJD: false, lastCap: null, hand: 1, lastHand: false, turnNum: 0, log: [] };
let battleDeck = null, allCards = [], jdSel = { d1: null, d2: null }, pDeck1 = [], pDeck2 = [];

async function getUserId() {
  TokenDB.init();
  return await TokenDB.getOrCreateGuestUser();
}

async function loadDecks() {
  let saved = [];
  try {
    const userId = await getUserId();
    saved = await TokenDB.getUserBattleDecks(userId);
  } catch (e) {
    saved = JSON.parse(localStorage.getItem('token_battle_decks') || '[]');
  }
  if (!saved.length) { document.getElementById('noDecksMsg').style.display = 'block'; return; }
  const sel = document.getElementById('deckSelect');
  saved.forEach((d, i) => { const o = document.createElement('option'); o.value = i; o.textContent = d.name; sel.appendChild(o); });
}
function loadCards() {}
function onDeckSelect() { document.getElementById('startBtn').disabled = !document.getElementById('deckSelect').value; }

async function startJD() {
  let saved = [];
  try {
    const userId = await getUserId();
    saved = await TokenDB.getUserBattleDecks(userId);
    const singleCards = await TokenDB.getUserCards(userId);
    const decks = await TokenDB.getUserDecks(userId);
    allCards = [];
    singleCards.forEach(c => allCards.push({ ...c, uid: 'card-' + c.id, displayValue: c.display_value }));
    decks.forEach(d => d.cards.forEach(c => allCards.push({ uid: 'deck-' + d.id + '-' + c.value, house: d.house, value: c.value, displayValue: c.displayValue || c.display_value || c.value })));
  } catch (e) {
    saved = JSON.parse(localStorage.getItem('token_battle_decks') || '[]');
    JSON.parse(localStorage.getItem('token_cards') || '[]').forEach(c => allCards.push({ ...c, uid: 'card-' + c.id }));
    JSON.parse(localStorage.getItem('token_decks') || '[]').forEach(d => d.cards.forEach(c => allCards.push({ uid: 'deck-' + d.id + '-' + c.value, house: d.house, value: c.value, displayValue: c.displayValue })));
  }
  battleDeck = saved[+document.getElementById('deckSelect').value];
  loadCards();
  pDeck1 = []; pDeck2 = [];
  console.log('battleDeck:', battleDeck);
  console.log('allCards:', allCards.length);
  battleDeck.deck1Cards.forEach(uid => { const c = allCards.find(x => x.uid === uid); console.log('d1 uid:', uid, 'found:', !!c); if (c) pDeck1.push({ ...c }); });
  battleDeck.deck2Cards.forEach(uid => { const c = allCards.find(x => x.uid === uid); console.log('d2 uid:', uid, 'found:', !!c); if (c) pDeck2.push({ ...c }); });
  console.log('pDeck1:', pDeck1.length, 'pDeck2:', pDeck2.length);
  if (!pDeck1.length || !pDeck2.length) { alert('Error loading deck cards. Check console.'); return; }
  document.getElementById('setupScreen').classList.add('hidden');
  document.getElementById('jdScreen').classList.add('visible');
  renderJD();
}
function renderJD() {
  const all = [...pDeck1.map((c, i) => ({ ...c, dn: 1, idx: i })), ...pDeck2.map((c, i) => ({ ...c, dn: 2, idx: i }))].sort((a, b) => +b.value - +a.value);
  const cont = document.getElementById('jdCards'); cont.innerHTML = '';
  all.forEach(c => {
    const el = document.createElement('div'); el.className = 'jd-card'; el.style.borderColor = HOUSES[c.house].primary + '66';
    el.innerHTML = '<span class="house-' + c.house + '" style="font-size:11px">' + HOUSES[c.house].symbol + '</span><span class="jd-card-value">' + c.displayValue + '</span>';
    el.dataset.deck = c.dn; el.dataset.index = c.idx;
    el.onclick = () => selJD(c.dn, c.idx, el);
    cont.appendChild(el);
  });
}
function selJD(dn, idx, el) {
  const cur = dn === 1 ? jdSel.d1 : jdSel.d2;
  if (cur === idx) { el.classList.remove('selected'); if (dn === 1) jdSel.d1 = null; else jdSel.d2 = null; }
  else { document.querySelectorAll('.jd-card.selected').forEach(c => { if (+c.dataset.deck === dn) c.classList.remove('selected'); }); el.classList.add('selected'); if (dn === 1) jdSel.d1 = idx; else jdSel.d2 = idx; }
  document.getElementById('jdConfirmBtn').disabled = !(jdSel.d1 !== null && jdSel.d2 !== null);
}
function confirmJD() {
  gs.playerJD = [pDeck1.splice(jdSel.d1, 1)[0], pDeck2.splice(jdSel.d2, 1)[0]];
  document.getElementById('jdScreen').classList.remove('visible');
  coinToss();
}

function coinToss() {
  document.getElementById('cointossOverlay').classList.add('visible');
  const bull = Math.random() < 0.5; gs.turn = bull ? 'player' : 'ai';
  setTimeout(() => {
    document.getElementById('coin').textContent = bull ? 'üêÇ' : 'üêª';
    document.getElementById('cointossResult').textContent = bull ? 'BULL!' : 'BEAR!';
    document.getElementById('cointossResult').className = 'cointoss-result ' + (bull ? 'bull' : 'bear');
    document.getElementById('cointossText').textContent = bull ? 'You first!' : 'AI first!';
    setTimeout(() => { document.getElementById('cointossOverlay').classList.remove('visible'); startGame(); }, 1500);
  }, 1500);
}

function startGame() {
  const aiCards = genAI();
  gs.aiJD = [aiCards.splice(Math.floor(Math.random() * 10), 1)[0], aiCards.splice(9 + Math.floor(Math.random() * 9), 1)[0]];
  gs.deck = shuffle([...pDeck1, ...pDeck2, ...aiCards]);
  gs.playerHand = gs.deck.splice(0, 3); gs.aiHand = gs.deck.splice(0, 3); gs.table = gs.deck.splice(0, 4);
  gs.playerCaptures = []; gs.aiCaptures = []; gs.playerTokens = 0; gs.aiTokens = 0;
  gs.selected = null; gs.phase = 'playing'; gs.hand = 1; gs.turnNum = 0; gs.lastHand = false; gs.log = [];
  sysLog('Start'); sysLog('üìã Hand #1');
  document.getElementById('gameWrapper').classList.add('visible');
  render();
  if (gs.turn === 'ai') setTimeout(aiTurn, 1000); else startTimer();
}
function genAI() {
  const hs = ['bitcoin', 'ethereum', 'base', 'tysm'], h1 = hs[Math.floor(Math.random() * 4)];
  let h2 = hs[Math.floor(Math.random() * 4)]; while (h2 === h1) h2 = hs[Math.floor(Math.random() * 4)];
  const cards = [], vals = ['2','3','4','5','6','7','8','9','10','11'], dvs = ['2','3','4','5','6','7','8','9','10','J'];
  vals.forEach((v, i) => { cards.push({ uid: 'ai1-' + v, house: h1, value: v, displayValue: dvs[i] }); cards.push({ uid: 'ai2-' + v, house: h2, value: v, displayValue: dvs[i] }); });
  return cards;
}
function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

function render() { renderAI(); renderTable(); renderPlayer(); renderPiles(); renderStats(); renderTurn(); }
function renderAI() { 
  const c = document.getElementById('aiHand'); c.innerHTML = ''; 
  for (let i = 0; i < gs.aiHand.length; i++) { const el = document.createElement('div'); el.className = 'card-back'; c.appendChild(el); } 
}
function renderTable() { const c = document.getElementById('tableCards'); if (!gs.table.length) { c.innerHTML = '<span class="table-empty">Empty</span>'; return; } c.innerHTML = ''; gs.table.forEach(card => c.appendChild(createCard(card))); }
function renderPlayer() { const c = document.getElementById('playerHand'); c.innerHTML = ''; gs.playerHand.forEach((card, i) => { const el = createCard(card); el.onclick = () => selCard(i); el.ondblclick = () => playIdx(i); if (gs.selected === i) el.classList.add('selected'); c.appendChild(el); }); highlightCaps(); }
function renderPiles() {
  // Counts
  document.getElementById('playerCaptureCount').textContent = gs.playerCaptures.length;
  document.getElementById('aiCaptureCount').textContent = gs.aiCaptures.length;
  document.getElementById('deckCount').textContent = gs.deck.length;
  
  // Player JD pile
  const pJD = gs.playerJD.filter(c => c).length;
  document.getElementById('playerJDCount').textContent = pJD;
  const pJDStack = document.getElementById('playerJDStack');
  pJDStack.innerHTML = '';
  for (let i = 0; i < Math.min(pJD, 2); i++) { const card = document.createElement('div'); card.className = 'side-pile-card'; pJDStack.appendChild(card); }
  
  // Player JD pile state
  const jdPile = document.getElementById('playerJDPile');
  if (gs.hand === 1 || pJD === 0) { jdPile.classList.add('disabled'); jdPile.classList.remove('selected'); }
  else if (gs.lastHand) { jdPile.classList.add('disabled'); jdPile.classList.add('selected'); gs.useJD = true; }
  else { jdPile.classList.remove('disabled'); if (gs.useJD) jdPile.classList.add('selected'); else jdPile.classList.remove('selected'); }
  
  // AI JD pile
  const aJD = gs.aiJD.filter(c => c).length;
  document.getElementById('aiJDCount').textContent = aJD;
  const aJDStack = document.getElementById('aiJDStack');
  aJDStack.innerHTML = '';
  for (let i = 0; i < Math.min(aJD, 2); i++) { const card = document.createElement('div'); card.className = 'side-pile-card'; aJDStack.appendChild(card); }
  
  // Player captures pile
  const pCapStack = document.getElementById('playerCaptureStack');
  pCapStack.innerHTML = '';
  for (let i = 0; i < Math.min(gs.playerCaptures.length, 3); i++) { const card = document.createElement('div'); card.className = 'side-pile-card'; pCapStack.appendChild(card); }
  
  // AI captures pile
  const aCapStack = document.getElementById('aiCaptureStack');
  aCapStack.innerHTML = '';
  for (let i = 0; i < Math.min(gs.aiCaptures.length, 3); i++) { const card = document.createElement('div'); card.className = 'side-pile-card'; aCapStack.appendChild(card); }
}
function renderStats() { document.getElementById('scoreYou').textContent = calcScore('player'); document.getElementById('scoreAI').textContent = calcScore('ai'); }
function renderTurn() { const b = document.getElementById('turnBadge'); b.textContent = gs.turn === 'player' ? 'Your Turn' : 'AI Turn'; b.className = 'turn-badge ' + (gs.turn === 'player' ? 'your-turn' : 'ai-turn'); }

function toggleJDPile() { 
  if (gs.hand === 1 || gs.lastHand || !gs.playerJD.filter(c => c).length) return;
  gs.useJD = !gs.useJD; 
  renderPiles(); 
}
function selectJDPile() { 
  if (gs.hand === 1 || gs.lastHand || !gs.playerJD.filter(c => c).length) return;
  gs.useJD = true; 
  renderPiles(); 
}

function autoSelectJD() {
  // Find highest value card from each deck
  let best1 = 0, best2 = 0;
  pDeck1.forEach((c, i) => { if (+c.value > +pDeck1[best1].value) best1 = i; });
  pDeck2.forEach((c, i) => { if (+c.value > +pDeck2[best2].value) best2 = i; });
  
  // Clear previous selections
  document.querySelectorAll('.jd-card.selected').forEach(c => c.classList.remove('selected'));
  
  // Select them
  jdSel.d1 = best1;
  jdSel.d2 = best2;
  
  // Update UI
  document.querySelectorAll('.jd-card').forEach(el => {
    const dn = +el.dataset.deck, idx = +el.dataset.index;
    if ((dn === 1 && idx === best1) || (dn === 2 && idx === best2)) {
      el.classList.add('selected');
    }
  });
  
  document.getElementById('jdConfirmBtn').disabled = false;
  confirmJD();
}

function createCard(card) { const el = document.createElement('div'); el.className = 'game-card ' + card.house; el.innerHTML = '<span class="game-card-symbol house-' + card.house + '">' + HOUSES[card.house].symbol + '</span><span class="game-card-value">' + card.displayValue + '</span>'; return el; }

function selCard(i) { if (gs.turn !== 'player') return; gs.selected = gs.selected === i ? null : i; renderPlayer(); }
function playIdx(i) { if (gs.turn !== 'player') return; gs.selected = i; playSelected(); }
function highlightCaps() { document.querySelectorAll('.game-card.highlight-capture').forEach(el => el.classList.remove('highlight-capture')); if (gs.selected === null || gs.turn !== 'player') return; const card = gs.playerHand[gs.selected]; if (!card) return; const caps = findCaps(+card.value); document.getElementById('tableCards').querySelectorAll('.game-card').forEach((el, i) => { if (caps.includes(i)) el.classList.add('highlight-capture'); }); }
function playSelected() { if (gs.turn !== 'player' || gs.selected === null) return; const card = gs.playerHand.splice(gs.selected, 1)[0]; gs.selected = null; playCard(card, 'player'); }

function playCard(card, player) {
  if (player === 'player') stopTimer();
  gs.turnNum++;
  const val = +card.value, caps = findCaps(val), captured = [];
  let isToken = false;
  if (caps.length) { caps.sort((a, b) => b - a).forEach(i => captured.push(gs.table.splice(i, 1)[0])); const all = [card, ...captured]; if (player === 'player') { gs.playerCaptures.push(...all); gs.lastCap = 'player'; } else { gs.aiCaptures.push(...all); gs.lastCap = 'ai'; } if (!gs.table.length) { isToken = true; if (player === 'player') gs.playerTokens++; else gs.aiTokens++; } }
  else { gs.table.push(card); }
  addLog(player, card, captured, isToken);
  showAnim(player, card, captured, isToken, () => {
    if (!gs.playerHand.length && !gs.aiHand.length) { render(); setTimeout(endHand, 500); return; }
    if (player === 'player') { gs.turn = 'ai'; gs.selected = null; render(); setTimeout(() => { if (gs.aiHand.length && gs.turn === 'ai') aiTurn(); }, 500); }
    else { gs.turn = 'player'; gs.selected = null; render(); startTimer(); }
  });
}
function findCaps(val) { for (let i = 0; i < gs.table.length; i++) if (+gs.table[i].value === val) return [i]; const tv = gs.table.map(c => +c.value), combos = []; function bt(s, cur, sum) { if (sum === val && cur.length) { combos.push([...cur]); return; } if (sum > val) return; for (let i = s; i < tv.length; i++) { cur.push(i); bt(i + 1, cur, sum + tv[i]); cur.pop(); } } bt(0, [], 0); return combos.length ? combos[0] : []; }
function aiTurn() { if (!gs.aiHand.length || gs.turn !== 'ai') return; let best = 0, bestScore = -1; gs.aiHand.forEach((c, i) => { const caps = findCaps(+c.value); if (caps.length > bestScore) { bestScore = caps.length; best = i; } }); if (!bestScore) { let low = 0; gs.aiHand.forEach((c, i) => { if (+c.value < +gs.aiHand[low].value) low = i; }); best = low; } const card = gs.aiHand.splice(best, 1)[0]; playCard(card, 'ai'); }

function endHand() { gs.lastHand = gs.deck.length <= 6; if (!gs.deck.length && !gs.playerJD.filter(c => c).length && !gs.aiJD.filter(c => c).length) { endGame(); return; } gs.hand++; drawCards(); }
function drawCards() {
  const pJD = gs.playerJD.filter(c => c).length;
  if (gs.lastHand && pJD) { gs.playerJD.forEach((c, i) => { if (c) { gs.playerHand.push(c); gs.playerJD[i] = null; } }); while (gs.playerHand.length < 3 && gs.deck.length) gs.playerHand.push(gs.deck.shift()); }
  else { let drawn = false; for (let i = 0; i < 3; i++) { if (gs.useJD && !drawn && pJD) { const j = gs.playerJD.findIndex(c => c); if (j !== -1) { gs.playerHand.push(gs.playerJD[j]); gs.playerJD[j] = null; drawn = true; continue; } } if (gs.deck.length) gs.playerHand.push(gs.deck.shift()); } }
  const aJD = gs.aiJD.filter(c => c).length;
  if (gs.lastHand && aJD) { gs.aiJD.forEach((c, i) => { if (c) { gs.aiHand.push(c); gs.aiJD[i] = null; } }); while (gs.aiHand.length < 3 && gs.deck.length) gs.aiHand.push(gs.deck.shift()); }
  else { const use = gs.hand > 1 && aJD && Math.random() < 0.5; let drawn = false; for (let i = 0; i < 3; i++) { if (use && !drawn) { const j = gs.aiJD.findIndex(c => c); if (j !== -1) { gs.aiHand.push(gs.aiJD[j]); gs.aiJD[j] = null; drawn = true; continue; } } if (gs.deck.length) gs.aiHand.push(gs.deck.shift()); } }
  gs.useJD = false; sysLog('üìã Hand #' + gs.hand + (gs.lastHand ? ' (FINAL)' : '')); render();
  if (gs.turn === 'ai') setTimeout(aiTurn, 800); else startTimer();
}
async function endGame(surr = false) {
  stopTimer(); gs.phase = 'gameover';
  if (!surr && gs.table.length && gs.lastCap) { if (gs.lastCap === 'player') gs.playerCaptures.push(...gs.table); else gs.aiCaptures.push(...gs.table); gs.table = []; }
  let ps = surr ? 0 : calcScore('player'), as = surr ? Math.max(3, calcScore('ai')) : calcScore('ai');
  const win = ps > as, tie = ps === as;
  document.getElementById('gameoverIcon').textContent = win ? 'üèÜ' : (tie ? 'ü§ù' : 'üò¢');
  document.getElementById('gameoverTitle').textContent = surr ? 'SURRENDERED' : (win ? 'YOU WIN!' : (tie ? 'TIE!' : 'YOU LOSE'));
  document.getElementById('gameoverTitle').className = 'gameover-title ' + (win ? 'win' : 'lose');
  document.getElementById('finalScoreYou').textContent = ps; document.getElementById('finalScoreAI').textContent = as;
  document.getElementById('gameoverDetails').innerHTML = '<div class="gameover-detail"><span>Cards</span><span>' + gs.playerCaptures.length + ' vs ' + gs.aiCaptures.length + '</span></div><div class="gameover-detail"><span>TOKENs</span><span>' + gs.playerTokens + ' vs ' + gs.aiTokens + '</span></div>';
  document.getElementById('gameoverOverlay').classList.add('visible');

  try {
    const userId = await getUserId();
    await TokenDB.recordGame({
      player1Id: userId,
      player2Id: null,
      winnerId: win ? userId : null,
      player1Score: ps,
      player2Score: as,
      player1Tokens: gs.playerTokens,
      player2Tokens: gs.aiTokens,
      isSurrender: surr,
      isAiGame: true,
      gameLog: gs.log
    });
  } catch (e) {
    // noop
  }
}
function calcScore(p) { let s = 0; const caps = p === 'player' ? gs.playerCaptures : gs.aiCaptures, toks = p === 'player' ? gs.playerTokens : gs.aiTokens, other = p === 'player' ? gs.aiCaptures : gs.playerCaptures; if (caps.length > other.length) s++; s += toks; const myA = countAces(p), theirA = countAces(p === 'player' ? 'ai' : 'player'); if (myA > theirA) s++; return s; }
function countAces(p) { return (p === 'player' ? gs.playerCaptures : gs.aiCaptures).filter(c => c.value === '1' || c.displayValue === 'A').length; }

function startTimer() { stopTimer(); timeLeft = TURN_TIME; updTimer(); timer = setInterval(() => { timeLeft--; updTimer(); if (timeLeft <= 0) { stopTimer(); autoPlay(); } }, 1000); }
function stopTimer() { if (timer) { clearInterval(timer); timer = null; } }
function updTimer() { const f = document.getElementById('timerFill'), t = document.getElementById('timerText'); f.style.width = (timeLeft / TURN_TIME * 100) + '%'; t.textContent = timeLeft; f.classList.remove('warning', 'danger'); t.classList.remove('warning', 'danger'); if (timeLeft <= 5) { f.classList.add('danger'); t.classList.add('danger'); } else if (timeLeft <= 10) { f.classList.add('warning'); t.classList.add('warning'); } }
function autoPlay() { if (gs.turn !== 'player' || !gs.playerHand.length) return; sysLog('‚è±Ô∏è Auto'); let best = 0, bestScore = -1; gs.playerHand.forEach((c, i) => { const caps = findCaps(+c.value); if (caps.length > bestScore) { bestScore = caps.length; best = i; } }); if (!bestScore) { let low = 0; gs.playerHand.forEach((c, i) => { if (+c.value < +gs.playerHand[low].value) low = i; }); best = low; } playCard(gs.playerHand.splice(best, 1)[0], 'player'); }

function addLog(player, card, captured, isToken) { gs.log.push({ turn: gs.turnNum, player, card: card.displayValue, captured: captured.map(c => c.displayValue), isToken }); updLogPreview(player, card, captured, isToken); renderLogContent(); }
function sysLog(msg) { gs.log.push({ system: true, msg }); document.getElementById('logPreview').textContent = msg; renderLogContent(); }
function updLogPreview(player, card, captured, isToken) { let t = (player === 'player' ? '<span class="p">You</span>' : '<span class="a">AI</span>') + ' ' + card; if (captured.length) t += ' ‚Üí ' + captured.join(','); if (isToken) t += ' üéØ'; document.getElementById('logPreview').innerHTML = t; }
function renderLogContent() { const c = document.getElementById('logContent'); c.innerHTML = ''; [...gs.log].reverse().slice(0, 25).forEach(e => { const d = document.createElement('div'); if (e.system) { d.className = 'log-entry system'; d.textContent = e.msg; } else { d.className = 'log-entry ' + e.player; d.innerHTML = '#' + e.turn + ' ' + (e.player === 'player' ? 'You' : 'AI') + ' ' + e.card + (e.captured.length ? ' ‚Üí ' + e.captured.join(',') : '') + (e.isToken ? ' üéØ' : ''); } c.appendChild(d); }); }
function toggleLog() { logOpen = !logOpen; document.getElementById('logExpanded').classList.toggle('visible', logOpen); document.getElementById('logToggle').classList.toggle('open', logOpen); }

function showAnim(player, card, captured, isToken, cb) {
  const o = document.getElementById('playAnimation');
  document.getElementById('playInfo').textContent = player === 'player' ? 'YOU' : 'AI'; document.getElementById('playInfo').className = 'play-info ' + player;
  const pc = document.getElementById('playedCard'); pc.className = 'played-card game-card ' + card.house; pc.innerHTML = '<span class="house-' + card.house + '">' + HOUSES[card.house].symbol + '</span><span class="game-card-value" style="font-size:28px">' + card.displayValue + '</span>';
  document.getElementById('captureInfo').textContent = captured.length ? (isToken ? 'üéØ TOKEN!' : 'Takes:') : '';
  const cc = document.getElementById('capturedCards'); cc.innerHTML = ''; captured.forEach(c => { const m = document.createElement('div'); m.className = 'mini-card game-card ' + c.house; m.innerHTML = '<span class="house-' + c.house + '">' + HOUSES[c.house].symbol + '</span><span style="font-size:12px">' + c.displayValue + '</span>'; cc.appendChild(m); });
  o.classList.add('visible'); setTimeout(() => { o.classList.remove('visible'); if (isToken) { showToast('üéØ', 'TOKEN!'); setTimeout(cb, 500); } else cb(); }, captured.length ? 900 : 500);
}
function showToast(icon, title) { const t = document.getElementById('toast'); const iconEl = document.getElementById('toastIcon'); const titleEl = document.getElementById('toastTitle'); if (title === 'TOKEN!') { iconEl.textContent = ''; titleEl.innerHTML = '<img class="token-wordmark-toast" src="assets/token_icon.png" alt="TOKEN">'; } else { iconEl.textContent = icon; titleEl.textContent = title; } t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 1000); }

function showSurrender() { document.getElementById('surrenderOverlay').classList.add('visible'); }
function hideSurrender() { document.getElementById('surrenderOverlay').classList.remove('visible'); }
function confirmSurrender() { hideSurrender(); sysLog('üè≥Ô∏è Surrendered'); endGame(true); }

document.addEventListener('DOMContentLoaded', loadDecks);
</script>

  <script type="module" src="assets/wallet-ui.js"></script>
</body>
</html>
